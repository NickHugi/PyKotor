name: Compile and Test PyKotor

on: [push]

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # Disable automatic cancellation of other jobs
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install python venv from install_python_venv.ps1
      run: |  # create the venv early to work around an issue with the matrix runners' concurrency
        python -m venv .venv_${{ matrix.os }}_${{ matrix.python-version }}
        ./install_python_venv.ps1 -noprompt -venv_name .venv_${{ matrix.os }}_${{ matrix.python-version }}
      shell: pwsh

    - name: Install HoloPatcher dependencies
      run: |
        ./compile/deps_holopatcher.ps1 -noprompt -venv_name .venv_${{ matrix.os }}_${{ matrix.python-version }}
      shell: pwsh
      continue-on-error: true
    
    - name: Compile HoloPatcher
      run: |
        ./compile/compile_holopatcher.ps1 -noprompt -venv_name .venv_${{ matrix.os }}_${{ matrix.python-version }}
      shell: pwsh
      continue-on-error: true

    - name: Install Holocron Toolset dependencies
      run: |
        ./compile/deps_toolset.ps1 -noprompt -venv_name .venv_${{ matrix.os }}_${{ matrix.python-version }}
      shell: pwsh
      continue-on-error: true

    - name: Compile Holocron Toolset
      run: |
        ./compile/compile_toolset.ps1 -noprompt -venv_name .venv_${{ matrix.os }}_${{ matrix.python-version }}
      shell: pwsh
      continue-on-error: true

    - name: Install BatchPatcher dependencies
      run: |
        ./compile/deps_batchpatcher.ps1 -noprompt -venv_name .venv_${{ matrix.os }}_${{ matrix.python-version }}
      shell: pwsh
      continue-on-error: true

    - name: Compile BatchPatcher
      run: |
        ./compile/compile_batchpatcher.ps1 -noprompt -venv_name .venv_${{ matrix.os }}_${{ matrix.python-version }}
      shell: pwsh
      continue-on-error: true

    - name: Compile KotorDiff
      run: |
        ./compile/compile_kotordiff.ps1 -noprompt -venv_name .venv_${{ matrix.os }}_${{ matrix.python-version }}
      shell: pwsh
      continue-on-error: true

    - name: Compile GUIDuplicator
      run: |
        ./compile/compile_gui_duplicator.ps1 -noprompt -venv_name .venv_${{ matrix.os }}_${{ matrix.python-version }}
      shell: pwsh
      continue-on-error: true

    - name: Upload compiled binaries
      uses: actions/upload-artifact@v4
      if: always()  # This ensures the step runs regardless of previous step's success or failure
      with:
        name: publish_${{ matrix.os }}_${{ matrix.python-version }}
        path: ./dist/**

    - name: Install development packages
      run: |
        ./install_python_venv.ps1 -noprompt -venv_name .venv_${{ matrix.os }}_${{ matrix.python-version }}
        pip install -r requirements-dev.txt
      shell: pwsh

    - name: Run all unittests/pytests
      run: |
        ./install_python_venv.ps1 -noprompt -venv_name .venv_${{ matrix.os }}_${{ matrix.python-version }}
        python -m pytest tests -v -ra -o log_cli=true --capture=no --junitxml=pytest_report.xml --html=pytest_report.html --self-contained-html --tb=no --continue-on-collection-errors
      shell: pwsh
      continue-on-error: true

    - name: Upload Pytest Reports
      uses: actions/upload-artifact@v4
      if: always()  # Ensures this step runs even if the previous step fails
      with:
        name: pytest-reports_${{ matrix.os }}_${{ matrix.python-version }}
        path: |
          pytest_report.html
          pytest_report.xml

  update-readme:
    needs: build  # Assumes 'build' is the job id of the matrix job
    runs-on: ubuntu-latest  # Or any other suitable runner
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: pytest-reports

      - name: Extract and update README with custom test status badges
        shell: pwsh
        run: |
          $OS_NAMES = @("windows-latest", "ubuntu-latest", "macos-latest")
          $PYTHON_VERSIONS = @("3.8", "3.9", "3.10", "3.11", "3.12")
          
          # Ensure the extracted-reports directory is created
          $extractedReportsPath = "extracted-reports"
          New-Item -ItemType Directory -Force -Path $extractedReportsPath

          # Extract all downloaded artifacts
          Get-ChildItem pytest-reports -Filter *.zip | ForEach-Object {
            Expand-Archive -Path $_.FullName -DestinationPath $extractedReportsPath -Force
          }
          
          # Initialize a hashtable to store test results
          $testResults = @{}

          # Process each extracted report
          Get-ChildItem $extractedReportsPath -Recurse -Filter pytest_report.xml | ForEach-Object {
            $dirName = $_.Directory.Name
            [xml]$TestResultsXml = Get-Content $_.FullName
            $passedTests = $TestResultsXml.testsuite.tests - $TestResultsXml.testsuite.failures
            $failedTests = $TestResultsXml.testsuite.failures
            $totalTests = $TestResultsXml.testsuite.tests

            # Store results in hashtable
            $testResults[$dirName] = @{
              Passed = $passedTests
              Failed = $failedTests
              Total  = $totalTests
            }
          }

          # Update README with test results
          $ReadmePath = "./README.md"
          $ReadmeContent = Get-Content $ReadmePath -Raw
          foreach ($OS in $OS_NAMES) {
            foreach ($PYTHON_VERSION in $PYTHON_VERSIONS) {
              $OSBadge = $OS -replace '-latest', ''
              $BadgeNamePassed = "tests-passed-$OSBadge-${PYTHON_VERSION}"
              $BadgeNameFailed = "tests-failed-$OSBadge-${PYTHON_VERSION}"
              
              # Generate badge URLs with proper encoding and logo
              $BadgeNamePassedEncoded = [uri]::EscapeDataString($BadgeNamePassed)
              $BadgeNameFailedEncoded = [uri]::EscapeDataString($BadgeNameFailed)
              $BadgeURLPassed = "https://img.shields.io/badge/$BadgeNamePassedEncoded-brightgreen?style=flat&logo=checkmark"
              $BadgeURLFailed = "https://img.shields.io/badge/$BadgeNameFailedEncoded-red?style=flat&logo=close"

              # Badge Markdown
              $BadgeMarkdown = "![$BadgeNamePassed]($BadgeURLPassed) ![$BadgeNameFailed]($BadgeURLFailed)"
              
              # Regex to check if the badges already exist
              $BadgeRegexPassed = "\!\[$BadgeNamePassed\]\(https:\/\/img\.shields\.io\/badge\/.*\)"
              $BadgeRegexFailed = "\!\[$BadgeNameFailed\]\(https:\/\/img\.shields\.io\/badge\/.*\)"
              
              if ($ReadmeContent -match $BadgeRegexPassed -and $ReadmeContent -match $BadgeRegexFailed) {
                $ReadmeContent = $ReadmeContent -replace $BadgeRegexPassed, "![$BadgeNamePassed]($BadgeURLPassed)"
                $ReadmeContent = $ReadmeContent -replace $BadgeRegexFailed, "![$BadgeNameFailed]($BadgeURLFailed)"
              } else {
                $ReadmeContent += "`n$BadgeMarkdown"
              }
            }
          }

          # Write the updated README content to the file
          Set-Content -Path $ReadmePath -Value $ReadmeContent
          
          # Git configuration and commit
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add README.md
          git commit -m "Update README with custom test status badges"
          git push
