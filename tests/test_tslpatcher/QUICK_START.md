# Quick Start Guide - TSLPatcher Comprehensive Tests

## Prerequisites

Ensure you have the PyKotor development environment set up:

```powershell
# From the PyKotor root directory
uv sync
```

## Running Tests - Simple Examples

### 1. Test 2DAMEMORY Token Storage (Simplest)
```powershell
python tests/test_tslpatcher/test_diff_comprehensive.py Test2DAMemoryComprehensive.test_addrow_stores_row_index -v
```

**What this tests**: When a new row is added to a 2DA file, the diff engine should store the row index in a 2DAMEMORY token for cross-file references.

**Expected output**: Generated INI with `2DAMEMORY0=RowIndex` in the AddRow section.

### 2. Test 2DAMEMORY Cross-Reference Chain
```powershell
python tests/test_tslpatcher/test_diff_comprehensive.py Test2DAMemoryComprehensive.test_2damemory_cross_reference_chain -v
```

**What this tests**: The real-world pattern from dm_qrts mod where:
- weaponsounds.2da AddRow → stores index in 2DAMEMORY1
- baseitems.2da AddRow → uses 2DAMEMORY1 for weaponmattype column, stores own index in 2DAMEMORY2  
- item.uti GFF → uses 2DAMEMORY2 for BaseItem field

**Expected output**: Chain of 2DAMEMORY tokens linking three files together.

### 3. Test Complete Mod Scenario (New Force Power)
```powershell
python tests/test_tslpatcher/test_diff_comprehensive.py TestIntegrationComprehensive.test_full_mod_scenario_new_spell -v
```

**What this tests**: Complete mod workflow similar to "Bastila Has Battle Meditation":
- Add spell to spells.2da
- Add visual effect to visualeffects.2da
- Grant spell to multiple creature UTC files
- Use 2DAMEMORY tokens to link everything

**Expected output**: Comprehensive INI with linked 2DA and GFF modifications.

### 4. Test All GFF Field Types
```powershell
python tests/test_tslpatcher/test_diff_comprehensive.py TestGFFComprehensive.test_gff_modify_all_field_types -v
```

**What this tests**: Modification of every GFF field type:
- Numeric: Byte, Char, Word, Short, DWORD, Int, Int64, Float, Double
- String: String, ResRef
- Special: LocalizedString, Vector3, Vector4

**Expected output**: INI with field modifications for all types.

### 5. Test Real-World Mod Pattern (Ajunta Pall)
```powershell
python tests/test_tslpatcher/test_diff_comprehensive.py TestRealWorldScenarios.test_ajunta_pall_appearance_mod -v
```

**What this tests**: Real mod from workspace - ChangeRow modification to appearance.2da with many columns.

**Expected output**: ChangeRow section with RowIndex=370 targeting specific row.

## Running Test Suites

### Run All 2DAMEMORY Tests
```powershell
python tests/test_tslpatcher/test_diff_comprehensive.py Test2DAMemoryComprehensive -v
```

### Run All TLK/StrRef Tests
```powershell
python tests/test_tslpatcher/test_diff_comprehensive.py TestTLKStrRefComprehensive -v
```

### Run All GFF Tests
```powershell
python tests/test_tslpatcher/test_diff_comprehensive.py TestGFFComprehensive -v
```

### Run All Integration Tests
```powershell
python tests/test_tslpatcher/test_diff_comprehensive.py TestIntegrationComprehensive -v
```

### Run All Tests (Full Suite)
```powershell
python tests/test_tslpatcher/test_diff_comprehensive.py -v
```

## Understanding Test Output

Each test prints the generated INI content:

```ini
=== test_addrow_stores_row_index ===

; ============================================================================
;  TSLPatcher Modifications File — Generated by HoloPatcher (11/08/2025)
; ============================================================================

[Settings]
...

[2DAList]
Table0=spells.2da

[spells.2da]
AddRow0=spells_2da_addrow_2

[spells_2da_addrow_2]
RowLabel=2
label=new_spell
name=102
2DAMEMORY0=RowIndex         <-- This is the key part being tested!
ExclusiveColumn=label
```

## Debugging Test Failures

### Enable Logging
Set `logging_enabled=True` in the test's `run_diff()` call to see detailed diff engine output.

### Check Temp Files
Tests create temporary directories. If a test fails, check:
- `{temp_dir}/vanilla/` - Vanilla game files
- `{temp_dir}/modded/` - Modded files
- `{temp_dir}/tslpatchdata/` - Generated INI and resource files

### Verify INI Syntax
The generated INI should be valid TSLPatcher syntax. Compare against:
- [TSLPatcher Official Readme](../../wiki/TSLPatcher's-Official-Readme.md)
- [Real-world examples](C:\Users\boden\OneDrive\Documents\rev12_modbuild_workspace)

## Common Issues

### ModuleNotFoundError
Ensure all dependencies are installed:
```powershell
uv sync
```

### File Permission Errors
Tests use temp directories that should auto-cleanup. If you see permission errors, manually delete the temp directory.

### Test Skipped
Some tests are intentionally skipped (marked with `self.skipTest()`) because they test features not yet implemented in the diff engine.

## Next Steps

After running tests:

1. **Review generated INI** - Check if the output matches TSLPatcher syntax
2. **Test with TSLPatcher** - Copy generated INI to a real tslpatchdata folder and run TSLPatcher
3. **Compare with real mods** - Compare generated INI against mods in the workspace
4. **Add more tests** - Found an edge case? Add a test for it!

## Performance Tests

Performance tests create many files to stress-test the diff engine:

```powershell
# Test with 20 2DA files (should complete in < 30 seconds)
python tests/test_tslpatcher/test_diff_comprehensive.py TestPerformanceComprehensive.test_many_2da_files -v

# Test with 20 GFF files
python tests/test_tslpatcher/test_diff_comprehensive.py TestPerformanceComprehensive.test_many_gff_files -v
```

## Questions?

See [README_COMPREHENSIVE_TESTS.md](README_COMPREHENSIVE_TESTS.md) for full documentation.

