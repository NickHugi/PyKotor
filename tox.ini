[tox]
# Run tests on Python 3.8, 3.9, 3.12, 3.13 (Windows) and Linux (via WSL)
# 8 total environments: 4 Windows versions + 4 Linux versions
envlist = py38,py39,py312,py313,linux-py38,linux-py39,linux-py312,linux-py313
# Skip missing Python interpreters gracefully
skip_missing_interpreters = true
# Use tox-uv plugin for faster dependency resolution with uv
requires = tox-uv>=0.4.0

[testenv]
# Use uv-venv-runner for managing environments with uv
runner = uv-venv-runner
# Use uv to manage the environment
package = editable
# Install dependencies from requirements-dev.txt (Python 3.8 compatible)
deps = -rrequirements-dev.txt
# Run all tests from tests/common
# --tb=short: THIS IS THE KEY - shows traceback IMMEDIATELY when a test fails (not at the end)
# -s: disable output capture (ensures output appears immediately, no buffering)
# -v: verbose (show test names)
commands = python -m pytest tests/common/ --tb=short -s -v --maxfail=1
# Set environment variables for tests if needed
setenv =
    PYTHONUNBUFFERED = 1

[testenv:linux-py38]
# Linux test environment via WSL - Python 3.8
# Skip tox's environment management for WSL - we'll manage it ourselves
skip_install = true
# Allow wsl, wslpath, bash, python3, pip, sudo, and apt-get as external commands
allowlist_externals =
    wsl
    wslpath
    bash
    python3
    python3.8
    pip
    sudo
    apt-get
# Install system dependencies and set up venv in WSL, then run pytest
# wslpath converts Windows paths like G:\GitHub\PyKotor to /mnt/g/GitHub/PyKotor
# Note: If sudo password is required, you'll be prompted interactively
commands =
    wsl bash -c "cd $(wslpath '{toxinidir}') && sudo apt-get update -qq && sudo apt-get install -y -qq pkg-config libcairo2-dev python3.8-dev python3.8-venv libgirepository-1.0-dev libgirepository1.0-dev gir1.2-girepository-2.0-dev gobject-introspection && python3.8 -m venv .venv_linux38 && .venv_linux38/bin/pip install --upgrade pip && export PKG_CONFIG_PATH=/usr/lib/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig && .venv_linux38/bin/pip install -r requirements-dev.txt && .venv_linux38/bin/python -m pytest tests/common/ --tb=short -s -v --maxfail=1"
# Set environment variables for tests if needed
setenv =
    PYTHONUNBUFFERED = 1

[testenv:linux-py39]
# Linux test environment via WSL - Python 3.9
# Skip tox's environment management for WSL - we'll manage it ourselves
skip_install = true
# Allow wsl, wslpath, bash, python3, pip, sudo, and apt-get as external commands
allowlist_externals =
    wsl
    wslpath
    bash
    python3
    python3.9
    pip
    sudo
    apt-get
# Install system dependencies and set up venv in WSL, then run pytest
# wslpath converts Windows paths like G:\GitHub\PyKotor to /mnt/g/GitHub/PyKotor
# Note: If sudo password is required, you'll be prompted interactively
commands =
    wsl bash -c "cd $(wslpath '{toxinidir}') && sudo apt-get update -qq && sudo apt-get install -y -qq pkg-config libcairo2-dev python3.9-dev python3.9-venv libgirepository-1.0-dev libgirepository1.0-dev gir1.2-girepository-2.0-dev gobject-introspection && python3.9 -m venv .venv_linux39 && .venv_linux39/bin/pip install --upgrade pip && export PKG_CONFIG_PATH=/usr/lib/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig && .venv_linux39/bin/pip install -r requirements-dev.txt && .venv_linux39/bin/python -m pytest tests/common/ --tb=short -s -v --maxfail=1"
# Set environment variables for tests if needed
setenv =
    PYTHONUNBUFFERED = 1

[testenv:linux-py312]
# Linux test environment via WSL - Python 3.12
# Skip tox's environment management for WSL - we'll manage it ourselves
skip_install = true
# Allow wsl, wslpath, bash, python3, pip, sudo, and apt-get as external commands
allowlist_externals =
    wsl
    wslpath
    bash
    python3
    python3.12
    pip
    sudo
    apt-get
# Install system dependencies and set up venv in WSL, then run pytest
# wslpath converts Windows paths like G:\GitHub\PyKotor to /mnt/g/GitHub/PyKotor
# Note: If sudo password is required, you'll be prompted interactively
commands =
    wsl bash -c "cd $(wslpath '{toxinidir}') && sudo apt-get update -qq && sudo apt-get install -y -qq pkg-config libcairo2-dev python3.12-dev python3.12-venv libgirepository-1.0-dev libgirepository1.0-dev gir1.2-girepository-2.0-dev gobject-introspection && python3.12 -m venv .venv_linux312 && .venv_linux312/bin/pip install --upgrade pip && export PKG_CONFIG_PATH=/usr/lib/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig && .venv_linux312/bin/pip install -r requirements-dev.txt && .venv_linux312/bin/python -m pytest tests/common/ --tb=short -s -v --maxfail=1"
# Set environment variables for tests if needed
setenv =
    PYTHONUNBUFFERED = 1

[testenv:linux-py313]
# Linux test environment via WSL - Python 3.13
# Skip tox's environment management for WSL - we'll manage it ourselves
skip_install = true
# Allow wsl, wslpath, bash, python3, pip, sudo, apt-get, and add-apt-repository as external commands
allowlist_externals =
    wsl
    wslpath
    bash
    python3
    python3.13
    pip
    sudo
    apt-get
    add-apt-repository
# Install system dependencies and set up venv in WSL, then run pytest
# wslpath converts Windows paths like G:\GitHub\PyKotor to /mnt/g/GitHub/PyKotor
# Note: If sudo password is required, you'll be prompted interactively
# Python 3.13 requires deadsnakes PPA as it's not in default Ubuntu repositories
commands =
    wsl bash -c "cd $(wslpath '{toxinidir}') && sudo add-apt-repository -y ppa:deadsnakes/ppa 2>/dev/null || true && sudo apt-get update -qq && sudo apt-get install -y -qq software-properties-common pkg-config libcairo2-dev python3.13 python3.13-dev python3.13-venv libgirepository-1.0-dev libgirepository1.0-dev gir1.2-girepository-2.0-dev gobject-introspection && python3.13 -m venv .venv_linux313 && .venv_linux313/bin/pip install --upgrade pip && export PKG_CONFIG_PATH=/usr/lib/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig && .venv_linux313/bin/pip install -r requirements-dev.txt && .venv_linux313/bin/python -m pytest tests/common/ --tb=short -s -v --maxfail=1"
# Set environment variables for tests if needed
setenv =
    PYTHONUNBUFFERED = 1

